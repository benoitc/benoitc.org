<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>benoît chesneau web, artisan web.</title>

    <!--[if IE]>

    <script>
        // allow IE to recognize HTMl5 elements
        document.createElement('section');
        document.createElement('article');
        document.createElement('aside');
        document.createElement('footer');
        document.createElement('header');
        document.createElement('nav');
        document.createElement('time');

    </script>
    <![endif]-->
    <link rel="openid.server" href="http://www.myopenid.com/server">
    <link rel="openid.delegate" href="http://bchesneau.myopenid.com/">
    <link rel="home index" href="http://benoitc.org/" type="text/html">
    <link rel="me author" href="http://benoitc.org/benoitc.html" type="text/html">

    <link rel="stylesheet" href="<%= assets %>/css/layout.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="<%= assets %>/css/default.css" type="text/css" media="screen, projection" />
    
    <link rel="stylesheet" href="<%= assets %>/css/typography.css" type="text/css" media="screen, projection" />


</head>


<body>
        <header>
        <h1>
            <a rel="me author" href="<%= assets %>/benoitc.html">Benoît Chesneau</a>
        </h1>
        </header>
        <div id="edit">
            <h2>Nouvel article</h2>
            <form id="fedit" name="fedit" action="new.html"
                method="post">
                <p><label for="title">Titre<label><input type="text"
                        name="title" id="title" value=""></p>
                        
                <textarea name="body" id="body" cols="80"
                    rows="20"></textarea>

                <p><label for="labels">Libellés</label><input type="text"
                name="labels" id="labels" value=""></p>
                <p><input type="submit" name="save" id="save" value="Save">
            or <a href="cancel">Cancel</a> <span id="saved" style="display:none;">Saved</span></p>
            </form>
            <div id="mdpreview"></div>
        </div>

        <footer id="main-footer">
            <p class="copyright">Copyright &copy; 2009 by <a rel="me author"
                href="benoitc.html">Benoît Chesneau</a> </p>
        </footer>

    
</body>

    <script src="/_utils/script/json2.js"></script>
    <script src="/_utils/script/jquery.js"></script>
    <script src="/_utils/script/jquery.cookies.js"></script>
    <script src="/_utils/script/jquery.couch.js"></script>
    <script src="<%= assets %>/js/showdown.js"></script>

    <script src="<%= assets %>/js/textarea.jquery.js"></script>
    <script src="<%= assets %>/js/jquery.couchapp.js"></script>
    <script src="<%= assets %>/js/editor.js"></script>
    <script src="<%= assets %>/js/blog.js"></script>
    <script src="<%= assets %>/js/urlify.js"></script>

    <script>
        $(document).ready(function() {

            $.CouchApp(function(app) {
                app.loggedInNow(function(login) {
                    // w00t, we're logged in (according to the cookie)
                    $("#header").prepend('<span id="login">'+login+'</span>');
                    // setup CouchApp document/form system, adding app-specific callbacks
                    // rename docForm?
                    var B = new Blog(app);

                    var postForm = app.docForm("form#fedit", {
                        id : <%= docid %>,
                        fields : ["title", "body", "labels"],
                        template : {
                            doc_type : "post",
                            format : "markdown",
                            author : login
                        },
                        onLoad : function(doc) {
                            if (doc._id) {
                                $("#edit h2").html('Édition de ' + B.link_for(doc._id));
                            }

                            $('#save').click(function() {
                                if (!$("#title").val().match(/^['\-\"\/ !?&.,;:@\(\)\w\u00A1-\uFFFF]+$/i)) {
                                    alert("Titre invalide.");
                                    return false;
                                }
                            });

                        },
                        beforeSave : function(doc) {
                            doc.html = B.formatBody(doc.body);


                            if (!doc.created_at) {
                                doc.created_at = new Date().rfc3339();
                            }

                            if (!doc.slug) {
                                doc.slug = doc.created_at.slice(0, 10) + "_" +
                                   URLify(doc.title, 255);
                                doc._id = doc.slug;
                            }


                            doc.updated = new Date().rfc3339();
                            if(doc.labels) {
                                doc.labels = doc.labels.split(",");
                                for(var idx in doc.labels) {
                                    doc.labels[idx] = $.trim(doc.labels[idx]);
                                }
                            } 
                        },
                        success : function(resp) {
                           $("#saved").text("Saved _rev: "+resp.rev).fadeIn(500).fadeOut(3000);
                           $("#edit h2").html('Édition de ' + B.link_for(resp.id));
                        }
                    });  

                    new Editor(); 
                    }, function() {
                    // callback
                    $('body').append('<a href="<%= assets %>/account.html#'+document.location+'">redirect</a>');
                    var absurl = $('body a:last')[0].href;
                    document.location = absurl;
                });
            });
        
        });
    </script>
</html>
